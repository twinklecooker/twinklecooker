// Ajout dans le code global, au-dessus de la fonction !fight :

const effetsSpeciauxBoss = { "Buggy le Clown": (joueur, attaque) => { if (attaque.type === 'melee') return Math.floor(attaque.degats / 2); return attaque.degats; }, "Don Krieg": (joueur) => { joueur.vie -= 5; return "Don Krieg t'empoisonne avec ses armes ! Tu perds 5 PV."; }, "Crocodile": (joueur, ennemi) => { if (Math.random() < 0.3) { ennemi.vie += 10; return "Crocodile absorbe l'humidité pour se soigner de 10 PV !"; } }, "Ener": (attaque) => { if (attaque.type !== 'fruit' && Math.random() < 0.5) return 0; return attaque.degats; }, "Lucci": (joueur, ennemi, tour) => { if (tour % 3 === 0) { joueur.vie -= 10; return "Lucci utilise Rokuougan ! Tu perds 10 PV de contre-attaque."; } }, "Magellan": (joueur) => { joueur.vie -= 7; return "Magellan t'empoisonne ! Tu perds 7 PV."; }, "Kaido": (attaque) => Math.floor(attaque.degats * 0.6), "Katakuri": () => Math.random() < 0.5 ? 'esquive' : null, "Prince Loki (fictif pour Elbaf)": (joueur) => { if (Math.random() < 0.2) { joueur.etourdi = true; return "Loki t'étourdit ! Tu perds ton prochain tour."; } } };

// Ensuite mise à jour dans la boucle de combat du !fight : let tour = 1; while (ennemi.vie > 0 && joueur.vie > 0) { if (joueur.etourdi) { log += "Tu es étourdi et ne peux pas attaquer ce tour-ci !\n"; delete joueur.etourdi; } else { const attaque = Object.values(attaques)[Math.floor(Math.random() * Object.values(attaques).length)]; let degats = attaque.degats;

if (effetsSpeciauxBoss[ennemi.nom]) {
        const effet = effetsSpeciauxBoss[ennemi.nom];
        const modif = effet(joueur, attaque, tour, ennemi);
        if (typeof modif === 'number') degats = modif;
        else if (modif === 'esquive') {
            log += `${ennemi.nom} esquive ton attaque !\n`;
            degats = 0;
        } else if (typeof modif === 'string') log += modif + "\n";
    }

    degats = applyHaki(joueur, degats, ennemi.isBoss);
    ennemi.vie -= degats;
    log += `Tu utilises ${attaque.type} et infliges ${degats} dégâts.\n`;
}

if (ennemi.vie <= 0) break;

const attaqueMob = Math.floor(Math.random() * 15) + 5;
const attaqueNom = ennemi.attaques ? ennemi.attaques[Math.floor(Math.random() * ennemi.attaques.length)] : 'Attaque';
joueur.vie -= attaqueMob;
log += `${ennemi.nom} utilise **${attaqueNom}** et t'inflige ${attaqueMob} dégâts.\n`;

// Effet passif du boss en fin de tour (poison, soin, etc)
if (effetsSpeciauxBoss[ennemi.nom]) {
    const postEffet = effetsSpeciauxBoss[ennemi.nom](joueur, ennemi, tour);
    if (typeof postEffet === 'string') log += postEffet + "\n";
}
tour++;

}

